#!/usr/bin/python3

#
# Copyright (C) 2023 Nethesis S.r.l.
# SPDX-License-Identifier: GPL-2.0-only
#

# Setup Dedalo hotspot

import sys
import json
from euci import EUci
from nethsec import utils, firewall

def configure_fw():
    u = EUci()
    ret = list()
    rules = ['ns_hs_uamport', 'ns_hs_dhcp', 'ns_hs_dns']
    for r in rules:
        ret.append(firewall.add_template_rule(u, r, link="dedalo/config"))
    z, f = firewall.add_template_zone(u, 'ns_hotspot', link="dedalo/config")
    if not ret or not z or not f:
        return False
    return True


def setup_dedalo():
    u = EUci()
    links = firewall.get_all_linked(u, "dedalo/config")
    if links["firewall"]:
        # already configured
        return True

    if not configure_fw():
        return False

    interface = "hotspot"
    u.set("network", interface, "interface")
    u.set("network", interface, "proto", "none")
    u.set("network", interface, "ipv6", "0")
    u.set("network", interface, "device", f"tun-{interface}")
    u.set("network", interface, "ns_link", "dedalo/config")
    u.set("network", interface, "ns_tag", ["automated"])
    u.commit("network")
    u.commit("firewall")
    return True

if setup_dedalo():
    sys.exit(0)
else:
    sys.exit(1)
