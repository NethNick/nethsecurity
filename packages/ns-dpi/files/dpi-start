#!/bin/sh

#
# Copyright (C) 2022 Nethesis S.r.l.
# SPDX-License-Identifier: GPL-2.0-only
#

#
# DPI: setup firewall rules
#

# Cleanup existing table
if nft list tables inet | grep -q 'table inet dpi'; then
    nft delete table inet dpi
fi

enabled=$(uci get dpi.config.enabled)
if [ "$enabled" = "0" ]; then
    exit 0
fi

# To enable CT labels, create an iptables rule (similar rules on nftables do not enable CT labels).
for c in INPUT OUTPUT FORWARD; do
    if ! iptables -t mangle -C $c -m connlabel --label dummy -m comment --comment "Init CT labels" 2>/dev/null; then
        iptables -t mangle -A $c -m connlabel --label dummy -m comment --comment "Init CT labels";
    fi
done

# Setup CT labeld for nftables witch uses a different path than iptables
ln -sf /etc/xtables/connlabel.conf /etc

# Generate netify flow actions plugin configuration
/usr/sbin/dpi-config

# Load the firewall configuration
/usr/sbin/dpi-nft | nft -f -
