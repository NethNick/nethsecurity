#!/bin/sh

#
# Copyright (C) 2022 Nethesis S.r.l.
# SPDX-License-Identifier: GPL-2.0-only
#

zone=${1:-lan}

uci -q delete firewall.ns_redirect_dns_${zone}
uci -q delete firewall.ns_redirect_dns_${zone}_bypass

# Prepare ipset
uci set firewall.ns_redirect_dns_${zone}_bypass="ipset"
uci set firewall.ns_redirect_dns_${zone}_bypass.name="ns_redirect_dns_${zone}_bypass"
uci set firewall.ns_redirect_dns_${zone}_bypass.enabled="1"
uci set firewall.ns_redirect_dns_${zone}_bypass.family="inet"
uci set firewall.ns_redirect_dns_${zone}_bypass.match="net"

# Create DNAT rule
uci set firewall.ns_redirect_dns_${zone}="redirect"
uci set firewall.ns_redirect_dns_${zone}.name="Intercept-DNS-from-${zone}"
uci set firewall.ns_redirect_dns_${zone}.src="${zone}"
uci set firewall.ns_redirect_dns_${zone}.src_dport="53"
uci set firewall.ns_redirect_dns_${zone}.dest_port="5300"
uci set firewall.ns_redirect_dns_${zone}.proto="tcp udp"
uci set firewall.ns_redirect_dns_${zone}.target="DNAT"
uci set firewall.ns_redirect_dns_${zone}.ipset="ns_redirect_dns_${zone}_bypass"

uci commit firewall
/etc/init.d/firewall restart
