#!/bin/sh

#
# Copyright (C) 2023 Nethesis S.r.l.
# SPDX-License-Identifier: GPL-2.0-only
#

# Regenerate a user certificate
instance=$1
user=$2
expiration=${3:-3600}
if [ -z "$instance" ] || [ -z "$user" ]; then
    exit 1
fi

pki_dir="/etc/openvpn/$instance/pki"
req_f="$pki_dir/reqs/$user.req"
key_f="$pki_dir/private/$user.key"
crt_f="$pki_dir/issued/$user.crt"
if [ -f "$req_f" ] || [ -f "$key_f" ] || [ -f "$crt_f" ]; then
    rm -f "$req_f" "$key_f" "$crt_f"
    EASYRSA_PKI="$pki_dir" EASYRSA_CERT_EXPIRE="$expiration" EASYRSA_BATCH=1 /usr/bin/easyrsa build-client-full "$user" nopass
else
    exit 2
fi
